TOP=../..

include $(TOP)/configure/CONFIG
#----------------------------------------
#  ADD MACRO DEFINITIONS AFTER THIS LINE
#=============================

#USR_CFLAGS += -S
#USR_CFLAGS += -E
USR_CFLAGS += -std=gnu99
USR_CFLAGS += -Werror -Wall -Wextra -Wno-unused-parameter
USR_CFLAGS += -Wundef
USR_CFLAGS += -Wshadow
USR_CFLAGS += -Wcast-align
USR_CFLAGS += -Wcast-qual
USR_CFLAGS += -Wwrite-strings
USR_CFLAGS += -Wredundant-decls
USR_CFLAGS += -Wmissing-prototypes
USR_CFLAGS += -Wmissing-declarations
USR_CFLAGS += -Wstrict-prototypes

USR_CFLAGS += -Wno-system-headers
# This tells the compiler to ignore errors generated by EPICS includes.  We need
# this because the EPICS headers have non strict prototypes in places.
USR_CPPFLAGS += -isystem $(EPICS_BASE)/include

# Make sure that we pick up the version from install_d/CONFIG.
TMBF_VERSION = $(shell . $(TOP)/install_d/CONFIG; echo $$VERSION)
USR_CFLAGS += -DTMBF_VERSION='"$(TMBF_VERSION)"'
# Compute a sensible format of build date
USR_CFLAGS += -DBUILD_DATE_TIME='"$(shell date '+%Y-%m-%d %H:%M')"'


STATIC_BUILD = YES

#=============================
# build an ioc application

PROD_IOC = tmbf

DBD += tmbf.dbd
# tmbf.dbd will be made up from these files:
tmbf_DBD += base.dbd
tmbf_DBD += generic.dbd

DBD += generic.dbd

# <name>_registerRecordDeviceDriver.cpp will be created from <name>.dbd
tmbf_SRCS += tmbf_registerRecordDeviceDriver.c
tmbf_SRCS += tune.c
tmbf_SRCS += device.c
tmbf_SRCS += epics_device.c
tmbf_SRCS += hashtable.c
tmbf_SRCS += persistence.c
tmbf_SRCS += hardware.c
tmbf_SRCS += tmbfMain.c
tmbf_SRCS += pvlogging.c
tmbf_SRCS += numeric.c

tmbf_LIBS += $(EPICS_BASE_IOC_LIBS)


# The following sources have automatically generated PUBLISH statements.
EPICS_EXPORTS = tune device


#===========================

include $(TOP)/configure/RULES
#----------------------------------------
#  ADD RULES AFTER THIS LINE

# Force tmbfMain to be rebuilt every time so that the build date and time is
# current.
tmbfMain.o: EMPTY
EMPTY:

# The numeric module uses a pre-built lookup table.
numeric.o: numeric-lookup.h


# Make everything listed in EPICS_EXPORTS depend on its associated .EPICS file
$(EPICS_EXPORTS:=.o): %.o: %.EPICS

%.EPICS: %.c epics_device.h
	$(CPP) -D__DEFINE_EPICS__ $(INCLUDES) $< | ../make_EPICS >$@

%.h: ../%.py
	$(PYTHON) $< >$@

TOP=../..

include $(TOP)/configure/CONFIG
#----------------------------------------
#  ADD MACRO DEFINITIONS AFTER THIS LINE
#=============================

#USR_CFLAGS += -S
#USR_CFLAGS += -E
#USR_CFLAGS += -g

USR_CFLAGS += -std=gnu99
USR_CFLAGS += -Werror -Wall -Wextra -Wno-unused-parameter
USR_CFLAGS += -Wundef
USR_CFLAGS += -Wshadow
USR_CFLAGS += -Wcast-align
USR_CFLAGS += -Wcast-qual
USR_CFLAGS += -Wwrite-strings
USR_CFLAGS += -Wredundant-decls
USR_CFLAGS += -Wmissing-prototypes
USR_CFLAGS += -Wmissing-declarations
USR_CFLAGS += -Wstrict-prototypes
USR_CFLAGS += -Wconversion

# Annoyingly we need this when playing tricks with default initialisers
USR_CFLAGS += -Wno-missing-field-initializers

USR_CFLAGS += -Wno-system-headers
# This tells the compiler to ignore errors generated by EPICS includes.  We need
# this because the EPICS headers have non strict prototypes in places.
USR_CPPFLAGS += -isystem $(EPICS_BASE)/include


# Pick up configuration symbols and pass them through to the IOC build
include $(TOP)/install_d/CONFIG

USR_CFLAGS += -DTMBF_VERSION='"$(TMBF_VERSION)"'
USR_CFLAGS += -DFPGA_VERSION=$(FPGA_VERSION)
USR_CFLAGS += -DBUNCHES_PER_TURN=$(BUNCHES_PER_TURN)

# Compute a sensible format of build date
USR_CFLAGS += -DBUILD_DATE_TIME='"$(shell date '+%Y-%m-%d %H:%M')"'


ifdef DEBUG_TRACEBACK
# Allow panic_error() backtrace to show a backtrace with useful information.
USR_CFLAGS += -O0
USR_CFLAGS += -g
USR_CFLAGS += -mapcs-frame
USR_LDFLAGS += -rdynamic
endif

STATIC_BUILD = YES


#=============================

PROD_IOC = tmbf

DBD += tmbf.dbd
# tmbf.dbd will be made up from these files:
tmbf_DBD += base.dbd
tmbf_DBD += epics_device.dbd

# <name>_registerRecordDeviceDriver.cpp will be created from <name>.dbd
tmbf_SRCS += tmbf_registerRecordDeviceDriver.c
tmbf_SRCS += tmbfMain.c         # Entry point and initialisation
tmbf_SRCS += numeric.c          # Some fast numerical algorithsm
tmbf_SRCS += config_file.c      # Parse configuration file

# Hardware interfacing
tmbf_SRCS += hardware.c         # Interface to FPGA
tmbf_SRCS += ddr.c              # Interface to large DDR buffer

# TMBF components
tmbf_SRCS += adc_dac.c          # ADC and DAC interface and control
tmbf_SRCS += ddr_epics.c        # EPICS interface to DDR buffer
tmbf_SRCS += fir.c              # FIR filter control
tmbf_SRCS += bunch_select.c     # Bunch selection control
tmbf_SRCS += sequencer.c        # State sequencer control
tmbf_SRCS += triggers.c         # Trigger control and selection
tmbf_SRCS += detector.c         # I/Q detector
tmbf_SRCS += tune.c             # Tune measurement and high level control
tmbf_SRCS += tune_support.c     # Support library for tune measurement
tmbf_SRCS += tune_peaks.c       # High level tune peak detection
tmbf_SRCS += sensors.c          # Miscellaneous system health sensors
tmbf_SRCS += tune_follow.c      # Support for tune following
tmbf_SRCS += cholesky.c         # Special matrix inversion support

tmbf_LIBS += epics_device
tmbf_LIBS += $(EPICS_BASE_IOC_LIBS)


#===========================

include $(TOP)/configure/RULES
#----------------------------------------
#  ADD RULES AFTER THIS LINE

# Force tmbfMain to be rebuilt every time so that the build date and time is
# current.
tmbfMain.o: EMPTY
EMPTY:

# The numeric module uses a pre-built lookup table.
numeric.o: numeric-lookup.h


%.h: ../%.py
	$(PYTHON) $< >$@
